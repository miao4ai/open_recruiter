name: Build & Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      # ── Step 1: Build frontend ──────────────────────────────────────────
      - name: Install frontend dependencies
        working-directory: frontend
        run: npm install

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      # ── Step 2: Export embedding model as ONNX ─────────────────────────
      - name: Install backend dependencies
        working-directory: backend
        run: uv sync

      - name: Install ONNX export tools (system Python, not bundled)
        shell: bash
        run: |
          python -m pip install torch --index-url https://download.pytorch.org/whl/cpu
          python -m pip install "optimum[onnxruntime]"

      - name: Export embedding model as ONNX
        working-directory: backend
        shell: python
        run: |
          from optimum.onnxruntime import ORTModelForFeatureExtraction
          from transformers import AutoTokenizer
          print("Exporting BAAI/bge-small-en-v1.5 to ONNX...")
          model = ORTModelForFeatureExtraction.from_pretrained("BAAI/bge-small-en-v1.5", export=True)
          model.save_pretrained("models")
          tokenizer = AutoTokenizer.from_pretrained("BAAI/bge-small-en-v1.5")
          tokenizer.save_pretrained("models")
          print("ONNX export complete.")

      # ── Step 3: Bundle backend with PyInstaller ─────────────────────────
      - name: Bundle backend with PyInstaller
        working-directory: backend
        run: uv run pyinstaller open_recruiter.spec --noconfirm

      - name: Verify PyInstaller output
        shell: pwsh
        run: |
          if (-not (Test-Path "backend/dist/backend/backend.exe")) {
            Write-Error "PyInstaller build failed - backend.exe not found"
            exit 1
          }
          Write-Host "backend.exe OK"

      # ── Step 4: Compile Electron + package installer ────────────────────
      - name: Install root npm dependencies
        run: npm install

      - name: Compile Electron TypeScript
        run: npm run build:electron

      - name: Package with electron-builder
        run: npx electron-builder --config electron/electron-builder.json --win --publish never

      # ── Upload artifact ────────────────────────────────────────────────
      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: open-recruiter-windows-installer
          path: release/*.exe

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      # ── Step 1: Build frontend ──────────────────────────────────────────
      - name: Install frontend dependencies
        working-directory: frontend
        run: npm install

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      # ── Step 2: Export embedding model as ONNX ─────────────────────────
      - name: Install backend dependencies
        working-directory: backend
        run: uv sync

      - name: Install ONNX export tools (system Python, not bundled)
        run: |
          python3 -m pip install --break-system-packages torch --index-url https://download.pytorch.org/whl/cpu
          python3 -m pip install --break-system-packages "optimum[onnxruntime]"

      - name: Export embedding model as ONNX
        working-directory: backend
        shell: python3 {0}
        run: |
          from optimum.onnxruntime import ORTModelForFeatureExtraction
          from transformers import AutoTokenizer
          print("Exporting BAAI/bge-small-en-v1.5 to ONNX...")
          model = ORTModelForFeatureExtraction.from_pretrained("BAAI/bge-small-en-v1.5", export=True)
          model.save_pretrained("models")
          tokenizer = AutoTokenizer.from_pretrained("BAAI/bge-small-en-v1.5")
          tokenizer.save_pretrained("models")
          print("ONNX export complete.")

      # ── Step 3: Bundle backend with PyInstaller ─────────────────────────
      - name: Bundle backend with PyInstaller
        working-directory: backend
        run: uv run pyinstaller open_recruiter.spec --noconfirm

      - name: Verify PyInstaller output
        run: |
          if [ ! -f "backend/dist/backend/backend" ]; then
            echo "ERROR: PyInstaller build failed - backend binary not found"
            exit 1
          fi
          echo "backend binary OK"
          file backend/dist/backend/backend

      # ── Step 4: Compile Electron + package DMG ──────────────────────────
      - name: Install root npm dependencies
        run: npm install

      - name: Compile Electron TypeScript
        run: npm run build:electron

      - name: Package with electron-builder (sign only, no notarize)
        env:
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
        run: npx electron-builder --config electron/electron-builder.json --mac --publish never

      - name: Notarize DMG
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          DMG_PATH=$(ls release/*.dmg | head -1)
          echo "Submitting $DMG_PATH for notarization..."
          xcrun notarytool submit "$DMG_PATH" \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_SPECIFIC_PASSWORD" \
            --wait --timeout 15m
          echo "Stapling notarization ticket..."
          xcrun stapler staple "$DMG_PATH"
          echo "Notarization complete!"

      # ── Upload artifacts ───────────────────────────────────────────────
      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: open-recruiter-macos-dmg
          path: release/*.dmg

      - name: Upload macOS install helper
        uses: actions/upload-artifact@v4
        with:
          name: open-recruiter-macos-install-helper
          path: macos-install.command

  release:
    if: startsWith(github.ref, 'refs/tags/')
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/open-recruiter-windows-installer/*.exe
            artifacts/open-recruiter-macos-dmg/*.dmg
            artifacts/open-recruiter-macos-install-helper/macos-install.command
          generate_release_notes: true
